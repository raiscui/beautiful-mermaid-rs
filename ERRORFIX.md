# ERRORFIX

> 本次任务是初始化/复刻，不是典型 bugfix。
> 但如果过程中遇到关键错误与修复经验，也会在这里追加。

## 2026-01-30 21:00 - CLI 输出末尾出现 `%`（zsh 提示符粘连）

- 现象：
  - 执行 `printf 'graph LR\nA --> B\n' | cargo run --quiet -- --ascii` 时，输出最后一行后面紧跟一个 `%`。
- 原因：
  - `src/main.rs` 使用 `print!` 输出渲染结果，末尾没有补 `\n`。
  - 在 zsh 下，程序输出不以换行结尾时，shell 的提示符（通常是 `%`）会直接贴在最后一行后面，造成“看起来像多了个 %”。
  - 另外，`print!/println!` 在 stdout 遇到 BrokenPipe（下游提前关闭）时会 panic，不符合 CLI 常见行为。
- 修复：
  - `src/main.rs` 统一走 `write_stdout_with_trailing_newline`：
    - 输出后补齐末尾换行。
    - 捕获 `BrokenPipe` 并 0 退出，避免 panic。
- 验证：
  - `cargo test` 全通过。
  - 输出末尾检查：渲染结果以 `\n` 结尾，zsh 提示符不再粘连。
  - `| head -n 1` 等下游提前关闭场景不再出现 Broken pipe panic。

## 2026-02-01 00:41 - `beautiful-mermaid-rs --help/--version` 不生效，且空 stdin 触发 QuickJS 异常

- 现象：
  - 执行 `beautiful-mermaid-rs --help` / `beautiful-mermaid-rs --version` 没有输出帮助或版本。
  - 反而报错：`渲染 SVG 失败: JS 引擎错误: Exception generated by QuickJS`。
  - 在“直接运行但没有输入 stdin”的情况下，也会遇到类似报错，体验像“程序坏了”。
- 原因：
  - `src/main.rs` 先 `read_to_string(stdin)` 再解析参数。
  - 非交互环境下 stdin 常常立刻 EOF，导致读到空字符串，然后进入渲染路径触发 JS 异常。
  - 同时 CLI 没有 `--help/--version`，无法自发现用法。
- 修复：
  - `src/main.rs` 把“参数解析”前置，优先处理 `--help/-h` 与 `--version/-V`（不依赖 stdin）。
  - stdin 为空时返回明确提示，并用 exit code `2` 表示“用法错误”。
  - 增加参数校验：未知参数、`--use-ascii` 未配 `--ascii` 直接报错（避免 silent ignore）。
- 验证：
  - `cargo test` 通过。
  - `beautiful-mermaid-rs --help/--version` 正常输出。
  - `printf 'graph LR\nA --> B\n' | beautiful-mermaid-rs | head -n 1` 能输出 `<svg ...` 且 pipe 场景无 panic。

## 2026-02-01 20:55 - Flowchart/State 使用中文/Unicode 节点 ID 时渲染出 `-Infinity`

- 现象：
  - `printf 'graph TD\n开始 --> 结束\n' | beautiful-mermaid-rs` 输出的 SVG 出现：
    - `viewBox="0 0 -Infinity -Infinity"`
    - `width="-Infinity" height="-Infinity"`
  - `printf 'graph TD\n开始 --> 结束\n' | beautiful-mermaid-rs --ascii` 只输出空白
- 原因：
  - 上游 TS 版 `beautiful-mermaid` 的 `src/parser.ts` 使用 `\\w` / `[\\w-]` 匹配 Flowchart/State 的节点 ID，中文无法匹配，解析结果为空图。
  - 空图进入 dagre/layout 后，图尺寸被计算为 `-Infinity`，最终污染 SVG。
- 修复：
  - 在上游 TS 项目修复 parser：把 ID 匹配改为 Unicode 属性类（`\\p{L}\\p{N}` + `u` flag），并重建 `dist/beautiful-mermaid.browser.global.js`
  - 本仓库同步更新 vendor bundle：`vendor/beautiful-mermaid/beautiful-mermaid.browser.global.js`
  - 增加 Rust 回归测试：`tests/unicode_id_smoke.rs`
- 验证：
  - `cargo test` 通过
  - SVG 不再包含 `-Infinity`，且包含中文节点文本 `开始/结束`

## 2026-02-01 22:12 - ASCII/Unicode 输出在中文宽字符场景下边框错位

- 现象：
  - `printf 'graph TD\n开始 --> 结束\n' | beautiful-mermaid-rs --ascii` 中，中文在终端里占 2 列，导致某些行“显示更长”，边框看起来被顶出去。
- 原因：
  - Rust 侧渲染逻辑来自上游 TS 的 browser bundle（`vendor/beautiful-mermaid/beautiful-mermaid.browser.global.js`）。
  - 上游 ASCII 渲染器最初按 `string.length` 当作列宽，且输出阶段逐 cell 拼接字符串，没有处理宽字符的 2 列占用。
- 修复：
  - 在上游 TS 修复“显示宽度”模型（简化版 wcwidth）与输出跳列逻辑。
  - 本仓库用 `scripts/sync-vendor-bundle.sh` 同步最新 bundle 到 `vendor/beautiful-mermaid/`。
- 验证：
  - `cargo test` ✅
  - `graph TD\n开始 --> 结束\n` 的 ASCII/Unicode 输出边框对齐 ✅
  - Rust 回归测试 `tests/unicode_id_smoke.rs`：额外断言每一行“终端显示宽度”一致 ✅

## 2026-02-02 16:25 - 同步 vendor bundle 后 golden tests 失败（参考输出过期）

- 现象：
  - 执行 `make install`（内部会跑 `make sync-vendor-verify`）时失败，报错集中在：
    - `tests/ascii_testdata.rs`: `ascii_testdata_matches_reference` / `unicode_testdata_matches_reference`
  - 失败文件（示例）：
    - `tests/testdata/ascii/ampersand_lhs_and_rhs.txt`
    - `tests/testdata/ascii/preserve_order_of_definition.txt`
    - `tests/testdata/ascii/self_reference_with_edge.txt`
    - 以及对应的 `tests/testdata/unicode/*.txt`
- 原因：
  - 这次同步了更新后的上游 TS bundle（`vendor/beautiful-mermaid/beautiful-mermaid.browser.global.js`）。
  - 上游在“自环/多边合并”场景的布局/走线策略发生了变化，导致 ASCII/Unicode 渲染输出改变。
  - 本仓库的 golden 文件仍然是旧输出，因此对比失败。
- 修复：
  - 更新上述 golden 文件里的期望输出，使其与最新 vendor bundle 对齐。
- 验证：
  - `cargo test` 全通过 ✅
  - `make install` 端到端通过（tsup build → sync vendor → cargo test → release build → install）✅

## 2026-02-02 21:24 - 上游 TS bundle 再次变更导致 golden 失败（并改良为可一键更新）

- 现象：
  - 你再次执行 `make install`（内部会跑 `sync-vendor-verify`）后失败。
  - 这次同步到的新 vendor bundle sha256 为 `18ac06ce...`（产物体积也有增长）。
  - mismatch 的用例包含（ASCII/Unicode 成对变化）：
    - `ampersand_lhs_and_rhs`
    - `cls_all_relationships`
    - `er_identifying`
    - `preserve_order_of_definition`
    - `self_reference_with_edge`
- 原因：
  - golden 的本质是“锁定当前输出”，所以一旦上游 bundle 更新且布局/走线/label 排版有变化，就会触发对比失败。
- 修复：
  - 更新上述 `tests/testdata/{ascii,unicode}/*.txt` 的期望输出，使其与最新 vendor bundle 对齐。
  - 改良 `tests/ascii_testdata.rs`：
    - 增加 `UPDATE_GOLDEN=1` 模式，遇到 mismatch 自动写回 golden 文件，避免下次再手工逐个改。
    - 写回后会 panic 提示“重新运行测试确认稳定”，防止 silent 更新掩盖问题。
- 验证：
  - `cargo test` 全通过 ✅
  - `make install` 端到端通过（tsup build → sync vendor → cargo test → release build → install）✅
- 额外观察（潜在风险）：
  - `preserve_order_of_definition` 这类包含自环/循环边的案例在当前 bundle 下渲染变慢，导致 golden tests 整体耗时上升（本机观测 70-100s 级别）。

## 2026-02-06 16:12 - 上游 TS bundle 更新后 Unicode golden 过期（`make install` 失败）

- 现象：
  - 执行 `make install`（内部会跑 `sync-vendor-verify`）时失败。
  - 报错为 `tests/ascii_testdata.rs` 的 `unicode_testdata_matches_reference` 输出不一致。
  - 首个暴露的 mismatch 文件为：
    - `tests/testdata/unicode/ampersand_lhs_and_rhs.txt`
- 原因：
  - `sync-vendor-verify` 重建并同步了上游 TS bundle（本次 sha256 为 `b48b9228...`）。
  - 上游在相关用例的布局/走线细节上有变化, 导致 Unicode 渲染输出变化。
  - golden 参考输出仍是旧版本, 因此对比失败。
- 修复：
  - 使用仓库内置的 `UPDATE_GOLDEN=1` 模式自动更新 Unicode golden:
    - `UPDATE_GOLDEN=1 cargo test --test ascii_testdata unicode_testdata_matches_reference`
  - 实际更新了 2 个文件（之前只看到 1 个是因为断言遇到第一个 mismatch 会提前退出）：
    - `tests/testdata/unicode/ampersand_lhs_and_rhs.txt`
    - `tests/testdata/unicode/preserve_order_of_definition.txt`
- 验证：
  - `cargo test` 全通过 ✅
  - `make install` 端到端通过 ✅

## 2026-02-06 19:33 - Unicode（默认 relaxed）渲染过慢：补齐 native `__bm_getPathRelaxed`

- 现象：
  - Unicode golden tests（`unicode_testdata_matches_reference`）在 QuickJS 环境下耗时非常长（本机观测 70-100s）。
- 原因：
  - Rust 侧仅注入 `__bm_getPath` / `__bm_getPathStrict`。
  - 但 Unicode 默认走 TS 的 relaxed 路由（`getPathRelaxed()`），之前没有 native fast path。
  - 结果：relaxed A* 热循环仍在 QuickJS 解释执行 → 极慢。
- 修复：
  - Rust：实现 native relaxed A*（步长 + crossing penalty + segment reuse hard rule），并注入 `globalThis.__bm_getPathRelaxed(...)`。
  - TS：`getPathRelaxed()` 检测到 `__bm_getPathRelaxed` 时优先走 native。
  - 同步 vendor：更新 `vendor/beautiful-mermaid/beautiful-mermaid.browser.global.js`。
- 验证：
  - `scripts/sync-vendor-bundle.sh` 全通过（含 `cargo test`）。
  - Unicode golden tests 耗时降到 ~3.6s（本机观测）。
