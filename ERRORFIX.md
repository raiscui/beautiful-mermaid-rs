# ERRORFIX

> 本次任务是初始化/复刻，不是典型 bugfix。
> 但如果过程中遇到关键错误与修复经验，也会在这里追加。

## 2026-01-30 21:00 - CLI 输出末尾出现 `%`（zsh 提示符粘连）

- 现象：
  - 执行 `printf 'graph LR\nA --> B\n' | cargo run --quiet -- --ascii` 时，输出最后一行后面紧跟一个 `%`。
- 原因：
  - `src/main.rs` 使用 `print!` 输出渲染结果，末尾没有补 `\n`。
  - 在 zsh 下，程序输出不以换行结尾时，shell 的提示符（通常是 `%`）会直接贴在最后一行后面，造成“看起来像多了个 %”。
  - 另外，`print!/println!` 在 stdout 遇到 BrokenPipe（下游提前关闭）时会 panic，不符合 CLI 常见行为。
- 修复：
  - `src/main.rs` 统一走 `write_stdout_with_trailing_newline`：
    - 输出后补齐末尾换行。
    - 捕获 `BrokenPipe` 并 0 退出，避免 panic。
- 验证：
  - `cargo test` 全通过。
  - 输出末尾检查：渲染结果以 `\n` 结尾，zsh 提示符不再粘连。
  - `| head -n 1` 等下游提前关闭场景不再出现 Broken pipe panic。

## 2026-02-01 00:41 - `beautiful-mermaid-rs --help/--version` 不生效，且空 stdin 触发 QuickJS 异常

- 现象：
  - 执行 `beautiful-mermaid-rs --help` / `beautiful-mermaid-rs --version` 没有输出帮助或版本。
  - 反而报错：`渲染 SVG 失败: JS 引擎错误: Exception generated by QuickJS`。
  - 在“直接运行但没有输入 stdin”的情况下，也会遇到类似报错，体验像“程序坏了”。
- 原因：
  - `src/main.rs` 先 `read_to_string(stdin)` 再解析参数。
  - 非交互环境下 stdin 常常立刻 EOF，导致读到空字符串，然后进入渲染路径触发 JS 异常。
  - 同时 CLI 没有 `--help/--version`，无法自发现用法。
- 修复：
  - `src/main.rs` 把“参数解析”前置，优先处理 `--help/-h` 与 `--version/-V`（不依赖 stdin）。
  - stdin 为空时返回明确提示，并用 exit code `2` 表示“用法错误”。
  - 增加参数校验：未知参数、`--use-ascii` 未配 `--ascii` 直接报错（避免 silent ignore）。
- 验证：
  - `cargo test` 通过。
  - `beautiful-mermaid-rs --help/--version` 正常输出。
  - `printf 'graph LR\nA --> B\n' | beautiful-mermaid-rs | head -n 1` 能输出 `<svg ...` 且 pipe 场景无 panic。

## 2026-02-01 20:55 - Flowchart/State 使用中文/Unicode 节点 ID 时渲染出 `-Infinity`

- 现象：
  - `printf 'graph TD\n开始 --> 结束\n' | beautiful-mermaid-rs` 输出的 SVG 出现：
    - `viewBox="0 0 -Infinity -Infinity"`
    - `width="-Infinity" height="-Infinity"`
  - `printf 'graph TD\n开始 --> 结束\n' | beautiful-mermaid-rs --ascii` 只输出空白
- 原因：
  - 上游 TS 版 `beautiful-mermaid` 的 `src/parser.ts` 使用 `\\w` / `[\\w-]` 匹配 Flowchart/State 的节点 ID，中文无法匹配，解析结果为空图。
  - 空图进入 dagre/layout 后，图尺寸被计算为 `-Infinity`，最终污染 SVG。
- 修复：
  - 在上游 TS 项目修复 parser：把 ID 匹配改为 Unicode 属性类（`\\p{L}\\p{N}` + `u` flag），并重建 `dist/beautiful-mermaid.browser.global.js`
  - 本仓库同步更新 vendor bundle：`vendor/beautiful-mermaid/beautiful-mermaid.browser.global.js`
  - 增加 Rust 回归测试：`tests/unicode_id_smoke.rs`
- 验证：
  - `cargo test` 通过
  - SVG 不再包含 `-Infinity`，且包含中文节点文本 `开始/结束`

## 2026-02-01 22:12 - ASCII/Unicode 输出在中文宽字符场景下边框错位

- 现象：
  - `printf 'graph TD\n开始 --> 结束\n' | beautiful-mermaid-rs --ascii` 中，中文在终端里占 2 列，导致某些行“显示更长”，边框看起来被顶出去。
- 原因：
  - Rust 侧渲染逻辑来自上游 TS 的 browser bundle（`vendor/beautiful-mermaid/beautiful-mermaid.browser.global.js`）。
  - 上游 ASCII 渲染器最初按 `string.length` 当作列宽，且输出阶段逐 cell 拼接字符串，没有处理宽字符的 2 列占用。
- 修复：
  - 在上游 TS 修复“显示宽度”模型（简化版 wcwidth）与输出跳列逻辑。
  - 本仓库用 `scripts/sync-vendor-bundle.sh` 同步最新 bundle 到 `vendor/beautiful-mermaid/`。
- 验证：
  - `cargo test` ✅
  - `graph TD\n开始 --> 结束\n` 的 ASCII/Unicode 输出边框对齐 ✅
  - Rust 回归测试 `tests/unicode_id_smoke.rs`：额外断言每一行“终端显示宽度”一致 ✅
